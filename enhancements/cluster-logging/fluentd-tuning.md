---
title: cluster-logging-log-forwarding
authors:
  - "@alanconway"
reviewers:
approvers:
creation-date: 2020-05-27
status: provisional
see-also:[]
replaces:[]
superseded-by:[]
---

# Tuning Fluentd Output Peformance

## Release Signoff Checklist

- [ ] Enhancement is `implementable`
- [ ] Design details are appropriately documented from clear requirements
- [ ] Test plan is defined
- [ ] Graduation criteria for dev preview, tech preview, GA
- [ ] User-facing documentation is created in [openshift-docs](https://github.com/openshift/openshift-docs/)

## Summary

Allow selected fluentd output `<buffer>` configuration fields to be specified
for `ClusterLogForwarder` outputs.

These settings are:
* *not* relevant to most users, default settings should give good general performance.
* only for *advanced* users with detailed knowledge of `fluentd` configuration and performance.
* only for performance tuning, they have no effect on functional aspects of logging.

These settings have weaker forward-compatibility guarantees than the rest of the API.
In future releases:
  - `fluentd` settings may be ignored, if the logging implementation changes.
  - values may be overridden by (present or future) settings in other logging APIs.
  - new sections may be introduced for new implementations, they may not have equivalent settings to `fluentd`

## Motivation

### Goals

Ultimately we want great performance "out of the box" with no user
intervention. However, today we can't always predict/detect the best settings;
customers have had to adjust `fluentd` parameters to get good performance.

Furthermore, some requirements *can't* be predicted or detected.  Optimizing for
low latency often conflicts with optimizing for high throughput. We can't
predict or detect that a user wants to aggressively optimize for one or the
other.

Goals:
* Expose selected, optional fluentd output tuning parameters in the ClusterLogForwarder API.
* Apply tuning parameters to the `fluentd` configuration generated by the CLO.

We will be successful when:
* An administrator is able to set defaults for selected `fluentd` parameters.
* Different outputs can be tuned separately for targets with different performance characteristics.

### Non-Goals

* Not implying that logging will always use `fluentd` or use it in the same way, tuning may be ignored in future releases.
* Not allowing general `fluentd` configuration: we expose only a subset of performance tuning parameters. Users that want full control of `fluentd` need to go unmanaged.
* Not a generic performance tuning API: we may introduce such APIs in future, or introduce new `tuning` sections.

## Proposal

Add an `output.tuning.fluentd` section to the ClusterLogForwarder.
Field names are based on fluentd 1.0 `<buffer>` configuration section.

The field names are copied exactly from `fluentd` 1.0, including the use of "_"
rather than camelCase. This emphasizes that these settings are not a general
API, they apply directly to the underlying `fluentd`.

Note: two important fields were renamed by `fluentd` between versions 0.12 and 1.0:
* `queue_limit_length` -> `total_limit_size`
* `num_threads` -> `flush_thread_count`

The following example shows all the new field names, all are optional.
For a full explanation see the [fluentd documentation](https://docs.fluentd.org/configuration/buffer-section)

```yaml
apiVersion: "logging.openshift.io/v1"
kind: "ClusterLogForwarder"
spec:
  outputs:
  - name: RemoteTarget
    type: syslog
    url: tls://somewhere.com
    tuning:
      fluentd:
        buffer:
          # Memory use
          chunk_limit_size: 1m
          total_limit_size: 32m             # Replaces 'queue_limit_length' in 0.12
          overflow_action: exception

          # Flushing output behavior
          flush_thread_count: 2              # Replaces 'num_threads' in 0.12
          flush_mode: interval
          flush_interval: 5s
          flush_at_shutdown: false

          # Retries
          retry_wait: 1                      # The wait interval for the first retry.
          retry_type: exponential_backoff    # Set 'periodic' for constant intervals.
          retry_max_interval: 300
```

The `tuning` section refers to the *local sending behaviour*. It is independent
of the output `type`, which describes the *remote target*. All other output fields
define the location of the *remote target* and depend on the output type. In the
example above `RemoteTarget` forwards to a remote `syslog` target, but the
tuning parameters apply to the local `fluentd` sender.

All the chosen settings relate to the latency vs. throughput
trade-off. Optimizing for throughput favors batching to reduce network packet
count; bigger buffers and queues, delayed flushes and retries. Optimizing for
low latency favours sending data as quickly as possible and *avoiding* build-up
of batches; shorter queues/buffers to minimize memory use, rapid flush and
retry.

The buffer type (file or memory) is not available for tuning. That is determined
by the CLO.

The CLO *may* override these settings if they would break functional behavior,
for example settings that are incompatible with a particular output type.

In future the CLO *may* introduce new APIs that can overlap with tuning
parameters in `forwarding` or `collection`. For example we might provide generic
"retry" options on the forwarder API. How the overlap is resolved will be
decided if/when that happens.

### Implementation Details

The tuning values replace the environment variables that were previously used to
modify these defaults, for example `BUFFER_SIZE_LIMIT`. This proposal is
more flexible than the environment settings, as it allows different tuning
for different outputs.

Implementation is straight-forward, the existing code that applies the
environment settings will be replaced by code that takes the settings from the
`ClusterLogForwarder` CR.

### Risks and Mitigations

Risk: Users may set unreasonable values and break or slow down logging, or even
cause network congestion, for example reconnect storms.

Mitigation: Document this is an advanced feature and the user is responsible for
any misbehavior if they use it incorrectly.

## Implementation History

Not yet started

## Drawbacks

* User can shoot self in foot.
* Possible future conflicts/confusion between the "recommended" way and the "tuning" way to accomplish a given result.
* Possible confusion due to the dual role of `fluentd` as collector and forwarder.

## Alternatives

* Use unmanaged logging, allows free-for-all hacking on fluentd configuration. Possible now.
* Design generic API for output tuning.
  - Still a goal but not close enough for existing users.
* Improve out-of-box performance for a wider range of use cases.
  - Still a goal but not close enough for existing users.
